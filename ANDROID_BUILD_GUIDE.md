# MAESTRO Android App Build Guide

This guide explains how to package the MAESTRO web application as an offline Android app using Capacitor.

## Prerequisites

1. **Node.js 10.x** (already required for the project)
2. **Java Development Kit (JDK) 11 or higher**
3. **Android Studio** (latest version)
4. **Android SDK** (API level 22 or higher)

## Initial Setup

### 1. Install Dependencies

First, install the new Capacitor dependencies:

```bash
# Make sure you're using Node 10.x
export PATH="/usr/local/bin:$PATH"
node --version  # Should show v10.16.0

# Install dependencies
yarn install
```

### 2. Generate App Icons

Before building, create the required app icons:

```bash
# Create icon directories
mkdir -p public/images
mkdir -p android-icons

# You'll need to create these icon sizes from your logo:
# - 192x192 PNG (for PWA)
# - 512x512 PNG (for PWA)
# - Various Android icon sizes (generated by Android Studio)
```

Copy your logo to `public/images/logo_192.png` and `public/images/logo_512.png`.

### 3. Initialize Capacitor

```bash
# Initialize Capacitor (already configured in capacitor.config.json)
npx cap init --skip-git

# Add Android platform
npx cap add android
```

## Building the Android App

### 1. Build the React App

```bash
# Build the production version with legacy OpenSSL support
NODE_OPTIONS=--openssl-legacy-provider npm run build
```

### 2. Sync with Capacitor

```bash
# Copy web assets to Android project
npx cap sync android

# Or use the custom script
npm run build:android
```

### 3. Configure Android Permissions

The Android app needs specific permissions for Bluetooth and file access. These will be automatically added by Capacitor, but you may need to verify them in `android/app/src/main/AndroidManifest.xml`:

```xml
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
<uses-permission android:name="android.permission.BLUETOOTH_SCAN" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
```

### 4. Open in Android Studio

```bash
# Open Android project in Android Studio
npx cap open android
```

### 5. Configure Android Studio

In Android Studio:

1. **Wait for Gradle sync** to complete
2. **Update Gradle** if prompted
3. **Configure app signing** (for release builds):
   - Go to Build → Generate Signed Bundle/APK
   - Create a new keystore or use existing
   - Keep your keystore file safe!

### 6. Handle Web Bluetooth in Android WebView

Capacitor's WebView should support Web Bluetooth API on Android 6.0+. However, you may need to enable it explicitly:

Edit `android/app/src/main/java/com/maestroapp/mobile/MainActivity.java`:

```java
package com.maestroapp.mobile;

import com.getcapacitor.BridgeActivity;
import android.os.Bundle;
import android.webkit.WebSettings;

public class MainActivity extends BridgeActivity {
    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        // Enable Web Bluetooth in WebView
        WebSettings settings = this.bridge.getWebView().getSettings();
        settings.setJavaScriptEnabled(true);
    }
}
```

## Building the APK

### Debug Build

1. In Android Studio: **Build → Build Bundle(s)/APK(s) → Build APK(s)**
2. The APK will be in `android/app/build/outputs/apk/debug/`

### Release Build

1. **Build → Generate Signed Bundle/APK**
2. Choose **APK**
3. Select your keystore
4. Choose **release** build variant
5. The signed APK will be in `android/app/release/`

## Testing the Offline Functionality

1. **Install the APK** on an Android device
2. **Open the app** - it should load without internet
3. **Turn on Airplane Mode** to test offline
4. **Test all features**:
   - Navigation between pages
   - Muse connection (needs Bluetooth on)
   - Data recording
   - CSV export

## Troubleshooting

### Common Issues

1. **Bluetooth not working**:
   - Ensure location services are enabled
   - Grant all permissions when prompted
   - Android 12+ requires explicit Bluetooth permissions

2. **Build failures**:
   - Clear build cache: `cd android && ./gradlew clean`
   - Update Gradle: Android Studio will prompt
   - Check Java version: Should be JDK 11+

3. **App crashes on start**:
   - Check logcat in Android Studio
   - Verify all assets are included in build
   - Ensure service worker is registered correctly

### Debugging

Enable Chrome DevTools debugging:

1. Connect device via USB
2. Enable Developer Mode on device
3. Open Chrome on computer
4. Navigate to `chrome://inspect`
5. Find your app and click "inspect"

## Updating the App

When updating the app version:

1. Update version in `package.json`
2. Update version in `android/app/build.gradle`
3. Update `CACHE_NAME` in `public/serviceWorker.js`
4. Rebuild and sync: `npm run build:android`

## Distribution

### Google Play Store

1. Build a signed **App Bundle** (`.aab`) instead of APK
2. Create a Play Console account
3. Upload the `.aab` file
4. Fill in store listing details
5. Submit for review

### Direct Distribution

For internal use or testing:

1. Build a signed APK
2. Upload to a secure server
3. Users can download and install directly
4. Enable "Install from Unknown Sources" on devices

## Additional Notes

- The app bundles all assets for complete offline functionality
- Bluetooth connectivity works offline (device-to-device)
- CSV files are saved to device storage
- No internet connection required after installation
- Remote upload feature is disabled for offline use

## Support

For issues specific to the Android build, check:
- Capacitor documentation: https://capacitorjs.com/docs/android
- Android WebView docs: https://developer.android.com/guide/webapps/webview
- Web Bluetooth on Android: https://developer.chrome.com/articles/bluetooth/ 